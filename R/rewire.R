#' @importFrom igraph graph_from_adjacency_matrix as_edgelist
#' @importFrom stats cor
NULL

#' Degree preserving rewiring towards the target structure \code{eta}.
#'
#' @param edgelist Two column matrix, each row represents a directed edge from
#'   the first column to the second column.
#' @param eta Matrix, target structure eta generated by
#'   \code{wdnet::directed_joint_dist()}.
#' @param iteration Integer, number of iterations for \code{nattemtps} rewiring
#'   attempts.
#' @param nattempts Integer, number of rewiring attempts for each iteration.
#'   Default value equals the number of rows of edgelist.
#' @param rewire.track Logical, whether the rewiring history should be returned.
#'
#' @return Rewired edgelist, degree as well as rank based assortativity
#'   coefficients after each iteration, and rewiring history (including the
#'   index of sampled edges and rewiring result). For each rewiring attempt, two
#'   rows are sampled form the edgelist, for example Edge1:(v_1, v_2) and
#'   Edge2:(v_3, v_4), if the rewiring attempt is accepted, the sampled edges
#'   are replaced as (v_1, v_4), (v_3, v_2).
#' @export
#'
#' @examples
#' set.seed(1234)
#' edgelist <- rpanet(10000, control = panet.control(
#'    alpha = 0.3, beta = 0.1, gamma = 0.3, xi = 0.3,
#'    delta_out = 1, delta_in = 1))$edgelist
#' targetRho <- list("out-out" = -0.1, "out-in" = 0.3, "in-out" = 0.2, "in-in" = 0.1)
#' ret1 <- directed_joint_dist(edgelist, targetRho = targetRho)
#' ret2 <- directed_rewire(edgelist, eta = ret1$eta, iteration = 200)
#' plot(ret2$rho$Iteration, ret2$rho$"out-in")
#' 
directed_rewire <- function(edgelist, eta, 
                            iteration = 1, nattempts = NA, 
                            rewire.track = FALSE) {
  if (is.na(nattempts)) nattempts <- nrow(edgelist)
  edgelist <- as.matrix(edgelist)
  temp <- range(edgelist)
  sourceNode <- edgelist[, 1]
  targetNode <- edgelist[, 2]
  stopifnot(temp[1] == 1)
  stopifnot(temp[2] == length(unique(c(edgelist))))
  temp <- nodeStrength_cpp(startNode = sourceNode, 
                           endNode = targetNode, 
                           nNodes = temp[2], 
                           weight = 1,
                           weighted = FALSE)
  outd <- temp$outstrength
  ind <- temp$instrength
  
  df_s <- data.frame(type = rownames(eta), 
                     index = seq_len(nrow(eta)) - 1)
  df_t <- data.frame(type = colnames(eta), 
                     index = seq_len(ncol(eta)) - 1)
  type_s <- paste0(outd[sourceNode], "-", ind[sourceNode], split = "")
  type_t <- paste0(outd[targetNode], "-", ind[targetNode], split = "")
  
  index_s <- df_s[match(type_s, df_s$type), "index"]
  index_t <- df_t[match(type_t, df_t$type), "index"]
  sourceOut <- outd[sourceNode]
  sourceIn <- ind[sourceNode]
  targetOut <- outd[targetNode]
  targetIn <- ind[targetNode]
  r_sourceOut <- rank(outd[sourceNode], ties.method = "average")
  r_sourceIn <- rank(ind[sourceNode], ties.method = "average")
  r_targetOut <- rank(outd[targetNode], ties.method = "average")
  r_targetIn <- rank(ind[targetNode], ties.method = "average")
  rm(df_s, df_t, type_s, type_t, temp, outd, ind)
  
  ret <- directed_rewire_cpp(iteration, nattempts, 
                             targetNode - 1, 
                             sourceOut, sourceIn,
                             targetOut, targetIn,
                             r_sourceOut, r_sourceIn,
                             r_targetOut, r_targetIn,
                             index_s, index_t, 
                             eta, rewire.track)
  rho <- data.frame("Iteration" = c(0:iteration), 
                    "out-out" = NA, 
                    "out-in" = NA, 
                    "in-out" = NA, 
                    "in-in" = NA)
  rankRho <- data.frame("Iteration" = c(0:iteration), 
                        "r-out-out" = NA, 
                        "r-out-in" = NA, 
                        "r-in-out" = NA, 
                        "r-in-in" = NA)
  rho[1, 2:5] <- c("out-out" = stats::cor(sourceOut, targetOut), 
                   "out-in" = stats::cor(sourceOut, targetIn), 
                   "in-out" = stats::cor(sourceIn, targetOut),
                   "in-in" = stats::cor(sourceIn, targetIn))
  rho[2:(iteration + 1), 2] <- ret$out_out
  rho[2:(iteration + 1), 3] <- ret$out_in
  rho[2:(iteration + 1), 4] <- ret$in_out
  rho[2:(iteration + 1), 5] <- ret$in_in
  rankRho[1, 2:5] <- c("r-out-out" = stats::cor(r_sourceOut, r_targetOut), 
                       "r-out-in" = stats::cor(r_sourceOut, r_targetIn), 
                       "r-in-out" = stats::cor(r_sourceIn, r_targetOut),
                       "r-in-in" = stats::cor(r_sourceIn, r_targetIn))
  rankRho[2:(iteration + 1), 2] <- ret$r_out_out
  rankRho[2:(iteration + 1), 3] <- ret$r_out_in
  rankRho[2:(iteration + 1), 4] <- ret$r_in_out
  rankRho[2:(iteration + 1), 5] <- ret$r_in_in
  
  colnames(rho) <- c("Iteration", "out-out", "out-in", "in-out", "in-in")
  colnames(rankRho) <- c("Iteration", "r-out-out", "r-out-in", "r-in-out", "r-in-in")
  edgelist[, 2] <- ret$targetNode + 1
  result <- list(rho = rho, rankRho = rankRho,
                 edgelist = edgelist)
  if (rewire.track) {
    colnames(ret$rewireHistory) <- c("Attempt", "Edge1", "Edge2", "Accepted")
    ret$rewireHistory[, 1:3] <- ret$rewireHistory[, 1:3] + 1
    result$rewireHistory <- ret$rewireHistory
  }
  return(result)
}

#' Degree preserving rewiring towards the target structure \code{e}.
#'
#' @param edgelist Two column matrix, each row represents a directed edge.
#' @param iteration Integer, number of iterations for \code{nattemtps} rewiring
#'   attempts.
#' @param nattempts Integer, number of rewiring attempts for each iteration.
#'   Default value equals the number of rows of edgelist.
#' @param e Matrix, target structure \code{e} generated by
#'   \code{wdnet::undirected_joint_dist()}.
#' @param rewire.track Logical, whether the rewiring history should be returned.
#' @return Rewired edgelist, assortativity coefficient after each iteration, and
#'   rewiring history (including the index of sampled edges and rewiring
#'   result). For each rewiring attempt, two rows are sampled from the edgelist,
#'   for example Edge1:\{v_1, v_2\} and Edge2:\{v_3, v_4\}, we try to rewire the
#'   sampled edges as \{v_1, v_4\}, \{v_3, v_2\} (rewire type 1) or \{v_1,
#'   v_3\}, \{v_2, v_4\} (rewire type 2) with probability 1/2.
#' @export
#'
#' @examples
#' set.seed(1234)
#' mat1 <- matrix(rbinom(10000, 1, 0.3), 100)
#' mat1 <- pmax(mat1, t(mat1))
#' g1 <- igraph::graph_from_adjacency_matrix(mat1)
#' edgelist <- igraph::as_edgelist(g1)
#' ret1 <- undirected_joint_dist(edgelist)
#' ret2 <- undirected_rewire(edgelist, e = ret1$lbound$e, iteration = 500)
#' plot(ret2$rho$Iteration, ret2$rho$rho)
#' ret3 <- undirected_joint_dist(edgelist, targetRho = 0.5)
#' ret4 <- undirected_rewire(edgelist, e = ret3$e, iteration = 500)
#' plot(ret4$rho$Iteration, ret4$rho$rho)
#' 
undirected_rewire <- function(edgelist, e, 
                              iteration = 1, nattempts = NA, 
                              rewire.track = FALSE) {
  if (is.na(nattempts)) nattempts <- nrow(edgelist)
  
  edgelist <- as.matrix(edgelist)
  temp <- range(edgelist)
  stopifnot(temp[1] == 1)
  stopifnot(temp[2] == length(unique(c(edgelist))))
  degree <- data.frame(table(c(edgelist)))$Freq
  d_df <- data.frame(type = rownames(e), index = seq_len(nrow(e)) - 1)
  node1 <- edgelist[, 1]
  node2 <- edgelist[, 2]
  index1 <- d_df[match(degree[node1], d_df$type), "index"]
  index2 <- d_df[match(degree[node2], d_df$type), "index"]
  rm(d_df, temp)
  degree1 <- degree[c(node1, node2)]
  degree2 <- degree[c(node2, node1)]
  ret <- undirected_rewire_cpp(iteration, nattempts, 
                               node1, node2,
                               degree1, degree2,
                               index1, index2,
                               e, rewire.track)
  rm(node1, node2, degree1, degree2, index1, index2)
  rho <- data.frame(Index = c(0:iteration), rho = NA)
  rho[1, 2] <- edge_assort(edgelist, directed = FALSE)
  rho[2:(iteration + 1), 2] <- ret$rho
  colnames(rho) <- c("Iteration", "rho")
  edgelist <- cbind(ret$node1, ret$node2)
  result <- list(rho = rho,
                 edgelist = edgelist)
  if (rewire.track) {
    colnames(ret$rewireHistory) <- c("Attempt", "Edge1", "Edge2", "RewireType", "Accepted")
    ret$rewireHistory[, 1:3] <- ret$rewireHistory[, 1:3] + 1
    result$rewireHistory <- ret$rewireHistory
  }
  return(result)
}
